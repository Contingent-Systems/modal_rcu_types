\makeatletter % allow us to mention @-commands
\def\arcr{\@arraycr}
\makeatother
\section{Evaluation}
\label{sec:eval}
\begin{figure}[!t]
\centering 
\noindent
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=0.5]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]

\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
  
}

    \node[hollow node]       (r)     []   {$R$};
    \node[rsubtree] (t0) [below right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
    \node[rhollow node]           (k)    [below right of=t0]      {$H_1$};
    \node[subtree]             (kl)    [below left of=k]      {$T_{2}$};
    \node[hollow node]          (kr)    [below right of = k]  {$H_2$};
     \node[subtree]          (rlmst)    [below left of = kr]  {$T_4$};
     \node[subtree]  (t5) [below right of =rlmst] {$T_5$};
    \node[hollow node]             (krl)         [below left of = rlmst]        {$H_s$};
        \node[succn]          (nl)    [below left of = krl]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    \node[subtree]          (t6)       [below right of = krl]           {$T_{6}$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[rref node] (pr) [above right of= t0] {$pr$};
    \node[rref node] (cr) [above right of= k] {$cr$};
%    \node[fref node] (cf) [above right of = krl] {$cf$};
    \node[ref node] (lp) [above right of = kr] {$lp$};
%    \node[ref node] (sc) [above left of = krl] {$sc$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \path[->]  
	     (r)     edge node {} (t1)
             (r)     edge node {} (t0)
                (t0)     edge[draw=red] node {} (k)
                (k)    edge node {} (kl)
	     (k)    edge node {} (kr)

         (kr) edge node {} (rlmst)
          (rlmst) edge node {} (krl)
          (rlmst) edge node {} (t5)
             (krl) edge node {} (nl)

                (kr)     edge node {} (krr)
                %%%%%%%%%%%%%%%%%
                (pr) edge[draw=red] node {} (t0)
                (cr) edge[draw=red] node {} (k)
%                (cf) edge node {} (krl)
                (lp) edge node {} (kr)
 %               (sc) edge node {} (krl)
                (krl) edge node {} (t6)
;
\end{tikzpicture}
\caption{The writer traverses subtree $T_0$ to find the heap node $H_1$ with local references $pr$ and $cr$.}
\label{fig:del2.1}
\end{subfigure}\quad
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=0.5]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]

\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{fref node}=[circle,draw=green,inner sep=1.5,dashed]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draqw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
}

    \node[hollow node]       (r)     []   {$R$};
        \node[rsubtree] (t0) [below right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
    \node[rhollow node]           (k)    [below right of=t0]      {$H_1$};
    \node[blue node]            (kp1) [right of = k]   {$H_s$};    
    \node[subtree]             (kl)    [below left of=k]      {$T_{2}$};
    \node[hollow node]          (kr)    [below right of = k]  {$H_2$};
    \node[subtree]          (rlmst)    [below left of = kr]  {$T_4$};
      \node[subtree]  (t5) [below right of = rlmst] {$T_5$};
    \node[hollow node]             (krl)         [below left of = rlmst]        {$H_s$};
    \node[succn]          (nl)    [below left of = krl]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%
       \node[rref node] (pr) [above right of= t0] {$pr$};
    \node[rref node] (cr) [above right of= k] {$cr$};
    \node[fref node] (cf) [above right of = kp1] {$cf$};
    \node[ref node] (lp) [ left of = rlmst] {$lp$};
    \node[ref node] (sc) [ left of = krl] {$sc$};
     \node[subtree]          (t6)       [below right of = krl]           {$T_{6}$};
    \path[->]  
	     (r)     edge node {} (t1)
              (r)     edge node {} (t0)
                (t0)     edge[draw=red] node {} (k)
                
                %(r)     edge node {} (k) 
                (k)    edge node {} (kl)
	     (k)    edge node {} (kr)
	    (kr)    edge node {}  (rlmst)
                (kr)     edge node {} (krr)

         (kr) edge node {} (rlmst)
          (rlmst) edge node {} (krl)
                    (rlmst) edge node {} (t5)
             (krl) edge node {} (nl)

                (kp1)   edge[dashed,draw=green] node {} (kr)
	     (kp1)    edge[dashed,draw=green] node {} (kl)
             %%%%%%%%%%%%%%%%%%%%%%%%%%%
                            (pr) edge[draw=red] node {} (t0)
                (cr) edge[draw=red] node {} (k)
                (cf) edge[dashed,draw=green] node {} (kp1)
                %(lp) edge node {} (kr)
                %(sc) edge node {} (krl)
                                (lp) edge node {} (rlmst)
                (sc) edge node {} (krl)

                                (krl) edge node {} (t6)
;
;
\end{tikzpicture}
\caption{Traverse subtree $T_4$ starting from $H_2$ with references $lp$ and $sc$ to find successor $H'_1$ of $H_1$. Duplicating $H'_1$ as a fresh heap node before replacing $H_1$ with the fresh one.}
\label{fig:del2.2}
\end{subfigure}\quad
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=0.5]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]

\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rdref node}=[circle,draw=red,inner sep=1.5,dashed]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{fref node}=[circle,draw=green,inner sep=1.5,dashed]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draqw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
}


    \node[hollow node]       (r)     []   {$R$};
        \node[rsubtree] (t0) [below  right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
    \node[red node]           (k)    [below right of=t0]      {$H_1$};
    \node[hollow node]            (kp1) [right of = k]   {$H_s$};    
    \node[subtree]             (kl)    [below left of=k]      {$T_{2}$};
\node[hollow node]          (kr)    [below right of = k]  {$H_2$};
 
  \node[subtree]          (rlmst)    [below left of = kr]  {$T_4$};
   \node[subtree]  (t5) [below right of = rlmst] {$T_5$};
    \node[hollow node]             (krl)         [below left of = rlmst]        {$H_s$};
    \node[succn]          (nl)    [below left of = krl]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    \node[subtree]          (t6)       [below right of = krl]           {$T_{6}$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[rref node] (pr) [above right of= t0] {$pr$};
    \node[rdref node] (cr) [above right of= k] {$cr$};
    \node[ref node] (cf) [above right of = kp1] {$cf$};
    \node[ref node] (lp) [ left of = rlmst] {$lp$};
    \node[ref node] (sc) [left of = krl] {$sc$};

    \path[->]  
	     (r)     edge node {} (t1)
              (r)     edge node {} (t0)
                %(t0)     edge node {} (k)
                (t0)     edge[draw=red] node {} (kp1) 
                (k)    edge[dashed,draw=red] node {} (kl)
	     (k)    edge[dashed,draw=red] node {} (kr)
	  %  (kr)    edge node {}  (krl)
         (kr) edge node {} (rlmst)
          (rlmst) edge node {} (krl)
                              (rlmst) edge node {} (t5)
             (krl) edge node {} (nl)
                (kr)     edge node {} (krr)
                (kp1)   edge node {} (kr)
	     (kp1)    edge node {} (kl)
             %%%%%%%%%%%%%%%%%%%
                (pr) edge[draw=red] node {} (t0)
                (cr) edge[draw=red,dashed] node {} (k)
                (cf) edge node {} (kp1)
                (lp) edge node {} (rlmst)
                (sc) edge node {} (krl)
                 (krl) edge node {} (t6)

;
\end{tikzpicture}
\caption{Replace $H_1$ with fresh successor and synchronize with the readers.}
\label{fig:del2.3}
\end{subfigure} \quad
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=0.5]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]

\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rdref node}=[circle,draw=red,inner sep=1.5,dashed]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{fref node}=[circle,draw=green,inner sep=1.5,dashed]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draqw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
}


    \node[hollow node]       (r)     []   {$R$};
        \node[subtree] (t0) [below  right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
   
    \node[hollow node]            (kp1) [below right of = t0]   {$H_s$};    
    \node[subtree]             (kl)    [below left of=k]      {$T_{2}$};
\node[hollow node]          (kr)    [below right of = k]  {$H_2$};
 
  \node[rsubtree]          (rlmst)    [below left of = kr]  {$T_4$};
   \node[subtree]  (t5) [below right of = rlmst] {$T_5$};
    \node[rhollow node]             (krl)         [below left of = rlmst]        {$H_s$};
    \node[succn]          (nl)    [below left of = krl]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[ref node] (pr) [above right of= t0] {$pr$};
    
    \node[ref node] (cf) [above right of = kp1] {$cf$};
    \node[rref node] (lp) [ left of = rlmst] {$lp$};
    \node[rref node] (sc) [left of = krl] {$sc$};
\node[subtree]          (t6)       [below right of = krl]           {$T_{6}$};
    \path[->]  
	     (r)     edge node {} (t1)
              (r)     edge node {} (t0)
                %(t0)     edge node {} (k)
                (t0)     edge node {} (kp1) 
   
	  %  (kr)    edge node {}  (krl)
         (kr) edge node {} (rlmst)
          (rlmst) edge[draw=red] node {} (krl)
                              (rlmst) edge node {} (t5)
             (krl) edge node {} (nl)
                (kr)     edge node {} (krr)
                (kp1)   edge node {} (kr)
	     (kp1)    edge node {} (kl)
             %%%%%%%%%%%%%%%%%%%
                (pr) edge node {} (t0)
                
                (cf) edge node {} (kp1)
                (lp) edge[draw=red] node {} (rlmst)
                (sc) edge[draw=red] node {} (krl)
                                 (krl) edge node {} (t6)

;
\end{tikzpicture}
\caption{Unlinks old successor referenced by $sc$.}
\label{fig:del2.4}
\end{subfigure} \quad
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=0.5]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]
\tikzstyle{rdhollow node}=[rectangle,draw=red,inner sep=1.5,dashed]
\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rdref node}=[circle,draw=red,inner sep=1.5,dashed]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{fref node}=[circle,draw=green,inner sep=1.5,dashed]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draqw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
}


    \node[hollow node]       (r)     []   {$R$};
        \node[subtree] (t0) [below  right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
   
    \node[hollow node]            (kp1) [below right of = t0]   {$H_s$};    
    \node[subtree]             (kl)    [below left of=k]      {$T_{2}$};
\node[hollow node]          (kr)    [below right of = k]  {$H_2$};
 
  \node[rsubtree]          (rlmst)    [below left of = kr]  {$T_4$};
   \node[subtree]  (t5) [below right of = rlmst] {$T_5$};
    \node[rdhollow node]             (krl)         [below left of = rlmst]        {$H_s$};
    \node[succn]          (nl)    [below left of = krl]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[ref node] (pr) [above right of= t0] {$pr$};
    
    \node[ref node] (cf) [above right of = kp1] {$cf$};
    \node[rref node] (lp) [ left of = rlmst] {$lp$};
    \node[rdref node] (sc) [left of = krl] {$sc$};
\node[subtree]          (t6)       [below right of = krl]           {$T_{6}$};
    \path[->]  
	     (r)     edge node {} (t1)
              (r)     edge node {} (t0)
                %(t0)     edge node {} (k)
                (t0)     edge node {} (kp1) 
   
	  %  (kr)    edge node {}  (krl)
         (kr) edge node {} (rlmst)
          (rlmst) edge[draw=red] node {} (t6)
                              (rlmst) edge node {} (t5)
             (krl) edge node {} (nl)
                (kr)     edge node {} (krr)
                (kp1)   edge node {} (kr)
	     (kp1)    edge node {} (kl)
             %%%%%%%%%%%%%%%%%%%
                (pr) edge node {} (t0)
                
                (cf) edge node {} (kp1)
                (lp) edge[draw=red] node {} (rlmst)
                (sc) edge[draw=red,dashed] node {} (krl)
                                 (krl) edge[draw=red,dashed] node {} (t6)

;
\end{tikzpicture}
\caption{Safe unlinking of the old successor whose left subtree is null.}
\label{fig:del2.5}
\end{subfigure}\quad
\begin{subfigure}[b]{.4\linewidth}
\centering
\begin{tikzpicture}[scale=1]
\tikzstyle{ref node}=[circle,draw,inner sep=1.5]
\tikzstyle{hollow node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rhollow node}=[rectangle,draw=red,inner sep=1.5]
\tikzstyle{rdhollow node}=[rectangle,draw=red,inner sep=1.5,dashed]
\tikzstyle{sub node}=[triangle,draw,inner sep=1.5]
\tikzstyle{solid node}=[rectangle,draw,inner sep=1.5]
\tikzstyle{rdref node}=[circle,draw=red,inner sep=1.5,dashed]
\tikzstyle{rref node}=[circle,draw=red,inner sep=1.5]
\tikzstyle{fref node}=[circle,draw=green,inner sep=1.5,dashed]
\tikzset{
  red node/.style = {rectangle,draw=red,inner sep=0.75},
  treenode/.style = {circle, draqw=black, align=center, minimum size=0.1cm},
  subtree/.style  = {draw,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  rsubtree/.style ={draw=red,minimum size=0cm,inner sep=0,regular polygon,regular polygon sides=3},
  succn/.style = {circle,draw=black,fill=black},
  blue node/.style = {rectangle,draw=green,inner sep=1.5,dashed}
}


    \node[hollow node]       (r)     []   {$R$};
        \node[subtree] (t0) [below right of = r] [] {$T_0$};
    \node[subtree]           (t1)    [below left of=r]       {$T_{1}$};
    \node[hollow node]            (kp1) [below right of = t0]   {$H_s$};    
    \node[subtree]             (kl)    [below left of=kp1]      {$T_{2}$};
    \node[hollow node]          (kr)    [below right of = kp1]  {$H_2$};
    \node[rsubtree]          (rlmst)    [below left of = kr]  {$T_4$};
    \node[subtree]  (t5) [below right of = rlmst] {$T_5$};
    %\node[succn]          (nl)    [below left of = rlmst]  {};
    \node[subtree]          (krr)       [below right of = kr]           {$T_{3}$};
    \node[subtree]          (t6)       [below left of = rlmst]           {$T_{6}$};
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[ref node] (pr) [above right of= t0] {$pr$};
    \node[rref node] (lp) [ left of = rlmst] {$lp$};    
    \node[ref node] (cf) [above right of = kp1] {$cf$};    

    \path[->]  
	     (r)     edge node {} (t1)
              (r)     edge node {} (t0)
         %       (t0)     edge node {} (k)
         (t0)     edge node {} (kp1) 
         (kr)     edge node {} (krr)
         (kr) edge node {} (rlmst)
          (rlmst) edge node {} (t5)
  %       (rlmst) edge node {} (nl)
         (kp1)   edge node {} (kr)
	     (kp1)    edge node {} (kl)

(pr) edge node {} (t0)
                
                (cf) edge node {} (kp1)
                (lp) edge[draw=red] node {} (rlmst)
                (rlmst) edge[draw=red] node {} (t6)
;
\end{tikzpicture}
\captionof{figure}{Reclamation of the old successor.}
\label{fig:del2.6}
\end{subfigure}
\caption{\textsf{Delete} of a heap node with two children in BST~\cite{Arbel:2014:CUR:2611462.2611471}.}
\label{fig:del2}
\end{figure}
We have used our type system to check correct use of RCU primitives in two RCU data structures representative of the broader space.

Figure \ref{fig:rculist} gives the type-annotated code for \lstinline|add| and \lstinline|remove| operations on a linked list implementation of a bag data structure, following McKenney's example~\cite{McKenney2015SomeEO}.
Appendix \ref{appendix:bag_paul} our our technical report~\cite{isotek} contains the code for membership checking.

We have also type checked the most challenging part of an RCU binary search tree, the deletion (which also contains the code for a lookup).
Our implementation is a slightly simplified version of the Citrus BST~\cite{Arbel:2014:CUR:2611462.2611471}: their code supports fine-grained locking for multiple writers, while ours supports only one writer by virtue of using our single-writer primitives. For lack of space the annotated code is only in Appendix \ref{appendix:bst_del} our technical report~\cite{isotek}, but it motivates some of the conditional-related flexibility discussed in Section \ref{subsection:type-action}.
The use of disjunction ($Left|Right$) in field maps and paths is required to capture traversals which follow different fields at different times, such as the lookup in a binary search tree.

The most subtle aspect of the deletion is the final step in the case the node $H_1$ to remove has both children. In this case, the value $H_s$ of the left-most node of $H_1$'s right child --- the next element in the collection order --- is copied into a new \textit{freshly-allocated} node as shown in Figure \ref{fig:del2.1}, which is then used to \emph{replace} node $H_1$ as shown in Figure \ref{fig:del2.3}: the replacement's fields exactly match $H_1$'s except for the data (\textsc{T-Replace} via $\N_1 = \N_2$), and the parent is updated to reference the replacement, unlinking $H_1$. At this point, as shown in Figures \ref{fig:del2.3}-\ref{fig:del2.4}, there are two nodes with value $H_s$ in the tree (\textit{weak} BST property of the Citrus~\cite{Arbel:2014:CUR:2611462.2611471}): the replacement node, and what was the left-most node under $H_1$'s right child. This latter (original) node for $H_s$ must be unlinked as shown in Figure \ref{fig:del2.5}, which is simplified because by being left-most the left child is null, avoiding another round of replacement (\textsc{T-UnlinkH} via $\forall_{f\in dom(\N_1)} \ldotp f\neq f_2 \implies (\N_1(f) = \textsf{null}$).

The complexity in checking safety here is that once $H_1$ is found after traversing the subtree $T_0$ with references
\[ pr:rcuItr(l|r)^{k} \{l|r \rightarrow cr\},\, cr:rrcuItr(l|r)^{k}.(l|r) \{\}\]
where $(l|k)^{k}$ comes from $T_0$ traversal, another loop is used to find $H_s$ and its parent (since that node will later be removed as well) after traversing the subtree $T_4$ with references
\[lp:(l|r)^{k}.(l|r).r.(l|r)^{m} \{l|r \rightarrow sc\},\, lp:(l|r)^{k}.(l|r).r.l.(l)^{m}.l\{\}\]
where $(l|m)^{m}$ comes from $T_4$ traversal.

After $H_s$ is found, there are \emph{two} local unlinking operations as shown in Figures \ref{fig:2.3}-\ref{fig:2.5}, at different depths of the tree.  This is why the type system must keep separate abstract iteration counts, e.g., $k$ of $(l|r)^{k}$ or $m$ of $(l|r)^{m}$, for traversals in loops --- these indices act like multiple cursors into the data structure, and allow the types to carry enough information to keep those changes separate and ensure neither introduces a cycle.

To the best of our knowledge, we are the first to check such code for memory-safe use of RCU primitives modularly, without appeal to the specific implementation of RCU primitives.
\begin{comment}
The most subtle aspect of the deletion is the final step in the case the node $H_1$ to remove has both children.  In this case, the value $H'_1$ of the left-most node of $H_1$'s right child --- the next element in the collection order --- is copied into a new node, which is then used to \emph{replace} node $H_1$: the replacement's fields exactly match $H_1$'s except for the data (\textsc{T-Replace} via $\N_1 = \N_2$), and the parent is updated to reference the replacement, unlinking $H_1$. At this point, there are two nodes with value $H'_1$ in the tree (\textit{weak} BST property of the Citrus~\cite{Arbel:2014:CUR:2611462.2611471}): the replacement node, and what was the left-most node under $H_1$'s right child. This latter (original) node for $H'_1$ must be unlinked, which is simplified because by being left-most the left child is null, avoiding another round of replacement (\textsc{T-UnlinkH} via $\forall_{f\in dom(\N_1)} \ldotp f\neq f_2 \implies (\N_1(f) = \textsf{null}$).
The complexity in checking safety here is that once $H_1$ is found, another loop is used to find $H'_1$ and its parent (since that node will later be removed as well).
After $H'_1$ is found, there are \emph{two} local unlinking operations, at different depths of the tree.  This is why the type system must keep separate abstract iteration counts for traversals in loops --- these indices act like multiple cursors into the data structure, and allow the types to carry enough information to keep those changes separate and ensure neither introduces a cycle.

To the best of our knowledge, we are the first to check such code for memory-safe use of RCU primitives modularly, without appeal to the specific implementation of RCU primitives.

%%%%%%%%%%%%%%%%%%%

There are two 


\end{comment}
